name: Terraform PR (Plan)

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, reopened, ready_for_review, synchronize ]

permissions:
  contents: read
  pull-requests: write   # needed to comment on PR
  id-token: write        # OIDC -> AWS

env:
  AWS_REGION: us-east-1
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Prep plugin cache
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Find Terraform directories
        id: find
        run: |
          set -euo pipefail
          mapfile -t DIRS < <(git ls-files -z '*.tf' | xargs -0 -n1 dirname | sort -u)
          if [ ${#DIRS[@]} -eq 0 ]; then
            echo "dirs=[]" >> $GITHUB_OUTPUT
          else
            JSON=$(printf '%s\n' "${DIRS[@]}" | jq -R -s -c 'split("\n")[:-1]')
            echo "dirs=$JSON" >> $GITHUB_OUTPUT
          fi

      - name: Run Terraform plan
        id: plan
        if: steps.find.outputs.dirs != '[]'
        run: |
          set -euo pipefail
          SUMMARY=""
          for d in $(echo '${{ steps.find.outputs.dirs }}' | jq -r '.[]'); do
            echo "=== Planning $d ==="
            pushd "$d" >/dev/null

            if [ "$d" = "." ]; then
              KEY_SUFFIX="root/terraform.tfstate"
            else
              KEY_SUFFIX="$d/terraform.tfstate"
            fi
            KEY="${GITHUB_REPOSITORY}/${KEY_SUFFIX}"

            terraform init -input=false -upgrade -reconfigure \
              -backend-config="key=${KEY}"

            terraform validate

            set +e
            PLAN_OUT=$(terraform plan -input=false -no-color)
            CODE=$?
            set -e

            SUMMARY+="\n### üìÇ Directory: \`$d\`\n"
            SUMMARY+="\n<details><summary>Show Plan</summary>\n\n\`\`\`hcl\n${PLAN_OUT}\n\`\`\`\n</details>\n"

            if [ $CODE -eq 1 ]; then
              echo "Plan failed in $d"; exit 1
            fi

            popd >/dev/null
          done
          # Save summary to file for PR comment
          echo -e "$SUMMARY" > plan_summary.md
          echo "summary-file=plan_summary.md" >> $GITHUB_OUTPUT

      # - name: run pre-commit
      #   uses: pre-commit/action@v2.0.3
      #   with:
      #     extra_args: --all-files
      #   env:
      #     PRE_COMMIT_HOME: ${{ github.workspace }}/.cache/pre-commit
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      #     # To use a custom config file path, e.g. .github/.pre-commit-config.yaml
      #     # PRE_COMMIT_CONFIG: ${{ github.workspace }}/.github/.pre-commit-config.yaml
      #     # To disable the automatic git add after hooks modify files
      #     # PRE_COMMIT_NO_GIT_ADD: true
      - name: Run tfsec (Security Scanner)
        uses: aquasecurity/tfsec-pr-commenter-action@v1.0.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tfsec_args: --soft-fail --out results.json --format json . #allow merge but report issues
      - name: Setup TFlint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.51.1
      - name: Run TFLint per directory
        run: tflint --disable-rule-terraform_unused_declarations --init && tflint -f compact .

      - name: Comment plan on PR
        if: steps.find.outputs.dirs != '[]'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('${{ steps.plan.outputs.summary-file }}', 'utf8');
            const body = `## üìù Terraform Plan Results\n${summary}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
